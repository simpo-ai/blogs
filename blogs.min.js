var id;
class localScriptFile {
    constructor() {
        setTimeout(() => {
            var queryString = window.location.search;
            id = queryString.split("=")[1];
            getAllBlogs();
        }, 500);
    }
}
let baseUrl = 'https://dev-api.simpo.ai/business/blog/business';
let responseData;
function getAllBlogs() {
    showLoader();
    let data = {"businessId": id,"status": "ALL", "page": 0, "size": 20 }

    const requestOptions = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    };

    fetch(baseUrl, requestOptions).then(
        response => {
            if (!response) {
                throw new Error('Something went wrong...')
            }
            return response.json();
        })
        .then(
            data => {
                responseData = data.data.data;
                singleBlog = responseData[0]
                latestBlog(singleBlog);
                oldBlogs(responseData);
            }
        )
        .catch(
            error => {
                hideLoader();
                throw new Error(error.error.message);
            }
        )
}

function showLoader() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoader() {
    document.getElementById('loading').style.display = 'none';
}


function fn(text, count){
    return text.slice(0, count) + (text.length > count ? "..." : "");
}

function latestBlog(singleBlog){
     //for latest blog
     let image = document.getElementById('latestImage');
     if (!image) return;
     let incomingImgSource = singleBlog.blocks.find(x => x.type === 'image')
     image.src = incomingImgSource.data.file.url;
     image.alt = incomingImgSource.data.file.caption;

     let blogTitle = document.getElementById('blogTitle')
     if(!blogTitle) return;
     blogTitle.innerHTML = singleBlog.postTitle;

     let blogDescription = document.getElementById('blogDescription')
     if(!blogDescription) return;
     blogDescription.innerHTML = singleBlog.postSummary;

     let createTime = document.getElementById('createTime');
     if(!createTime) return;
     let dateTransform = new Date(singleBlog.createdTimeStamp);
     createTime.innerHTML = dateTransform.toDateString();

     let duration = document.getElementById('duration');
     if(!duration) return;
     let readingTime;
     if(singleBlog.readTime === 'NaN'){
         readingTime = 0
     }
     else{
         readingTime = singleBlog.readTime;
     }
     duration.innerHTML = readingTime + ' Min read';
    hideLoader();
}

function oldBlogs(){
    //fot all blogs
    var blogContainer = document.getElementById("blogContainer");
    responseData.shift();

    // Loop through the blogs array
    for (var i = 0; i < responseData.length; i++) {
        var blog = responseData[i];
        var blogBox = document.createElement("div");
        blogBox.className = "blog-box";

        //Create and append Image Section
        var imageDiv = document.createElement("div");
        imageDiv.className = "blog-image";

        var imageSource = document.createElement("img");
        let blogImageSource = blog.blocks.find(x => x.type === 'image');
        if(blogImageSource){
            imageSource.src = blogImageSource.data.file.url;
        }
        else{
            imageSource.src = "https://images.360dublincity.com/common/default-blog-thumb.png";
        }

        blogBox.appendChild(imageDiv);
        imageDiv.appendChild(imageSource);

        // Create and append title
        var titleElement = document.createElement("div");
        titleElement.className = "blog-title"
        titleElement.textContent = blog.postTitle;
        blogBox.appendChild(titleElement);

        // Create and append content
        var contentElement = document.createElement("div");
        contentElement.className = "blog-description"
        var results = fn(blog.postSummary,180)
        contentElement.textContent = results;
        blogBox.appendChild(contentElement);

        //create and append duration and creation date
        var bottom = document.createElement("div");
        bottom.className = "bottom-section";
        blogBox.appendChild(bottom);

        var durationDate = document.createElement("div");
        durationDate.className = "readtime-date";


        var date = document.createElement("div");
        date.className = "blog-box-time-stamp";
        let dateTransform = new Date(blog.createdTimeStamp);
        date.textContent = dateTransform.toDateString();

        var separator = document.createElement("div");
        separator.className = "separator";
        separator.textContent = "|";

        var blogReadTime = document.createElement("div");
        blogReadTime.className = "blog-box-read-time";
        let blogBoxReadingTime;
        if(blog.readTime === 'NaN' || blog.readTime === null){
            blogBoxReadingTime = 0;
        }
        else{
            blogBoxReadingTime = blog.readTime;
        }
        blogReadTime.textContent = blogBoxReadingTime + " Min read";

        bottom.appendChild(durationDate);
        durationDate.appendChild(date);
        durationDate.appendChild(separator);
        durationDate.appendChild(blogReadTime);

        //know more button
        var know = document.createElement("div");
        know.className = "single-readmore";
        bottom.appendChild(know);

        var readMoreText = document.createElement("div");
        readMoreText.className = "readmore-text";
        readMoreText.innerHTML += "Read More";
        know.appendChild(readMoreText);

        var arrow = document.createElement("img");
        arrow.className = "arrow-mark";
        arrow.src = "https://prod-simpo.s3.ap-south-1.amazonaws.com/prod-images/399311c1707822927001Icon%20Color.png";
        know.appendChild(arrow);

        // Append blog box to container
        blogContainer.appendChild(blogBox);

        let a = blog;
        //clickevent
        blogBox.addEventListener('click',function handleClick(event){
            window.location.href = 'blog-detail.html';
            window.localStorage.setItem('blogDetail',JSON.stringify(a));
        })
    }
}

var allBlogs = new localScriptFile();
function readMore(){
    window.location.href = `blog-detail.html`
    window.localStorage.setItem('blogDetail',JSON.stringify(singleBlog))
}
